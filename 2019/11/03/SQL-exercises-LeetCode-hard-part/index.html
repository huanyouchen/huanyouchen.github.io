<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python，Java，hacker"><title>LeetCode中的sql练习题-hard部分 | 幻悠尘的小窝</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-118684665-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '6630ddc4c60afb15b88971c6ab1d81a8';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">LeetCode中的sql练习题-hard部分</h1><a id="logo" href="/.">幻悠尘的小窝</a><p class="description">The quieter you become,the more you are able to hear.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/projects/"><i class="fa fa-github"> 作品</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/message-board/"><i class="fa fa-comments"> 留言</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">LeetCode中的sql练习题-hard部分</h1><div class="post-content"><p>本文包含LeetCode中hard部分的SQL练习题的解题思路和通过代码，关于题目描述可以查看<a href="https://leetcode.com/problemset/database/" target="_blank" rel="noopener">leetcode原网站</a>，或者<a href="https://leetcode-cn.com/problemset/database/" target="_blank" rel="noopener">leetcode中文网站</a></p>
<p>关于带锁的部分练习，由于博主没有开会员，所以没有在LeetCode网站上测试过，参考了别的博客写的。</p>
<p>Easy部分的练习题：<a href="https://huanyouchen.github.io/2019/09/11/SQL-exercises-in-LeetCode-easy-part/">点击这里</a><br>Medium部分的练习题：<a href="https://huanyouchen.github.io/2019/09/11/SQL-exercises-LeetCode-medium-part/">点击这里</a></p>
<a id="more"></a>

<h3 id="185-Department-Top-Three-Salaries-部门工资前三高的所有员工"><a href="#185-Department-Top-Three-Salaries-部门工资前三高的所有员工" class="headerlink" title="185    Department Top Three Salaries 部门工资前三高的所有员工"></a>185    Department Top Three Salaries 部门工资前三高的所有员工</h3><p>题目描述：<a href="https://leetcode.com/problems/department-top-three-salaries/" target="_blank" rel="noopener">https://leetcode.com/problems/department-top-three-salaries/</a></p>
<p>输出每个部门工资最高的一批人，工资第二高的一批人，工资第三高的一批人。<br>解题思路：</p>
<p>最简单的方法是用窗口函数，把员工表按部门分组，在组内按薪水逆序排序，把这个排序结果表和部门表连接，连接后取各部门薪水前三的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> d.Name <span class="keyword">as</span> Department, a. <span class="keyword">Name</span> <span class="keyword">as</span> Employee, a. Salary </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> e.*, <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> DepartmentId <span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">desc</span>) <span class="keyword">as</span> DeptPayRank </span><br><span class="line">    <span class="keyword">from</span> Employee e </span><br><span class="line">) a </span><br><span class="line"><span class="keyword">join</span> Department d</span><br><span class="line"><span class="keyword">on</span> a.DepartmentId = d.Id </span><br><span class="line"><span class="keyword">where</span> DeptPayRank &lt;=<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>第二种方法稍微不好理解点，过程如下：</p>
<p>首先找出部门不同的工资总共有多少，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> Salary</span><br><span class="line"><span class="keyword">FROM</span> Employee;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+--------+</span><br><span class="line">| Salary |</span><br><span class="line">+--------+</span><br><span class="line">|  85000 |</span><br><span class="line">|  80000 |</span><br><span class="line">|  60000 |</span><br><span class="line">|  90000 |</span><br><span class="line">|  69000 |</span><br><span class="line">|  70000 |</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure>
<p>找出一个部门中，工资最高，第二，第三高的。比如题目中的IT部门，工资分别为[90000, 85000, 85000, 70000, 69000]，要取出前三高的，即</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> E1.salary</span><br><span class="line"><span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E1</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">3</span> &gt; (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> E2.Salary)</span><br><span class="line">    <span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E2</span><br><span class="line">    <span class="keyword">WHERE</span> E1.Salary &lt; E2.Salary <span class="keyword">AND</span> E1.DepartmentId = E2.DepartmentId</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>当 e1 = e2 = [90000, 85000, 85000, 70000, 69000]时：</p>
<p>e1.Salary = 69000，e2.Salary 可以取值 [90000, 85000, 85000, 70000]，count(DISTINCT e2.Salary) = 3</p>
<p>e1.Salary = 70000，e2.Salary 可以取值 [90000, 85000, 85000]，count(DISTINCT e2.Salary) = 2</p>
<p>e1.Salary = 85000，e2.Salary 可以取值[90000]，count(DISTINCT e2.Salary) = 1</p>
<p>e1.Salary = 90000，e2.Salary 可以取值 []，count(DISTINCT e2.Salary) = 0</p>
<p>最后 3 &gt; count(DISTINCT e2.Salary)，所以 e1.Salary 可取值为 [90000, 85000, 85000, 70000]，即集合前 3 高的薪水</p>
<p>同样的Sales部门，工资分别为[8000, 60000], e1.Salary 可取值为[8000, 60000]</p>
<p>最后再把部门表连接起来：</p>
<p>代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> D.Name <span class="keyword">AS</span> Department, E1.Name <span class="keyword">AS</span> Employee, E1.Salary <span class="keyword">AS</span> Salary</span><br><span class="line"><span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Department <span class="keyword">AS</span> D</span><br><span class="line"><span class="keyword">ON</span> E1.departmentId = D.Id</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">3</span> &gt; (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> E2.Salary)</span><br><span class="line">    <span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E2</span><br><span class="line">    <span class="keyword">WHERE</span> E1.Salary &lt; E2.Salary <span class="keyword">AND</span> E1.DepartmentId = E2.departmentId</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Department, Salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>但是这样提交不对，错误提示例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">&#123;&quot;headers&quot;: &#123;&quot;Employee&quot;: [&quot;Id&quot;, &quot;Name&quot;, &quot;Salary&quot;, &quot;DepartmentId&quot;], &quot;Department&quot;: [&quot;Id&quot;, &quot;Name&quot;]&#125;, &quot;rows&quot;: &#123;&quot;Employee&quot;: [[1, &quot;Joe&quot;, 10000, 1]], &quot;Department&quot;: []&#125;&#125;</span><br><span class="line">Output:</span><br><span class="line">&#123;&quot;headers&quot;: [&quot;Department&quot;, &quot;Employee&quot;, &quot;Salary&quot;], &quot;values&quot;: [[null, &quot;Joe&quot;, 10000]]&#125;</span><br><span class="line">Expected:</span><br><span class="line">&#123;&quot;headers&quot;:[&quot;Department&quot;,&quot;Employee&quot;,&quot;Salary&quot;],&quot;values&quot;:[]&#125;</span><br></pre></td></tr></table></figure>
<p>题中考虑了Department表为空的情况，这时输出应该也为空。而我使用的是LEFT JOIN，还是输出了值。因此需要把两表连接方式改为INNER JOIN</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Write your MySQL query statement below</span></span><br><span class="line"><span class="keyword">SELECT</span> D.Name <span class="keyword">AS</span> Department, E1.Name <span class="keyword">AS</span> Employee, E1.Salary <span class="keyword">AS</span> Salary</span><br><span class="line"><span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> Department <span class="keyword">AS</span> D</span><br><span class="line"><span class="keyword">ON</span> E1.departmentId = D.Id</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">3</span> &gt; (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> E2.Salary)</span><br><span class="line">    <span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E2</span><br><span class="line">    <span class="keyword">WHERE</span> E1.Salary &lt; E2.Salary <span class="keyword">AND</span> E1.DepartmentId = E2.departmentId</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Department, Salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="262-Trips-and-Users"><a href="#262-Trips-and-Users" class="headerlink" title="262. Trips and Users"></a>262. Trips and Users</h3><p>题目描述：<a href="https://leetcode.com/problems/trips-and-users/" target="_blank" rel="noopener">https://leetcode.com/problems/trips-and-users/</a></p>
<p>解题思路：</p>
<p>第一种方法，先在Trips表中，按题目要求把时间在2013-10-01到2013-10-02之外的全排除，把客户和司机是被禁止的也全都排除。之后，按照日期分组，计算每组内的取消概率。</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    Request_at <span class="keyword">AS</span> <span class="string">'Day'</span>, </span><br><span class="line">    <span class="keyword">ROUND</span>(<span class="keyword">SUM</span>(<span class="keyword">IF</span>(<span class="keyword">Status</span>=<span class="string">'completed'</span>, <span class="number">0</span>, <span class="number">1</span>)) / <span class="keyword">COUNT</span>(<span class="keyword">id</span>), <span class="number">2</span>) <span class="keyword">AS</span> <span class="string">'Cancellation Rate'</span></span><br><span class="line"><span class="keyword">FROM</span> trips</span><br><span class="line"><span class="keyword">WHERE</span> Client_id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> Users_id</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">Users</span></span><br><span class="line">    <span class="keyword">WHERE</span> Banned = <span class="string">'No'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">AND</span> Driver_Id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> Users_id</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">Users</span></span><br><span class="line">    <span class="keyword">WHERE</span> Banned = <span class="string">'No'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">AND</span> Request_at <span class="keyword">between</span> <span class="string">'2013-10-01'</span> <span class="keyword">AND</span> <span class="string">'2013-10-03'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Request_at;</span><br></pre></td></tr></table></figure>

<h3 id="601-Human-Traffic-of-Stadium"><a href="#601-Human-Traffic-of-Stadium" class="headerlink" title="601    Human Traffic of Stadium"></a>601    Human Traffic of Stadium</h3><p>题目描述：<a href="https://leetcode.com/problems/human-traffic-of-stadium/" target="_blank" rel="noopener">https://leetcode.com/problems/human-traffic-of-stadium/</a></p>
<p>解题思路：首先在表中把流量少于100的都排除，然后可以利用表中的id判断日期至少连续的三天</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.*</span><br><span class="line"><span class="keyword">FROM</span> stadium <span class="keyword">as</span> a,stadium <span class="keyword">as</span> b,stadium <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">where</span> (a.id = b.id<span class="number">-1</span> <span class="keyword">and</span> b.id = c.id<span class="number">-1</span>) </span><br><span class="line">  <span class="keyword">and</span> (a.people&gt;=<span class="number">100</span> <span class="keyword">and</span> b.people&gt;=<span class="number">100</span> <span class="keyword">and</span> c.people&gt;=<span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>得到的结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+------+------------+--------+</span><br><span class="line">| id   | visit_date | people |</span><br><span class="line">+------+------------+--------+</span><br><span class="line">|    5 | 2017-01-05 |    145 |</span><br><span class="line">|    6 | 2017-01-06 |   1455 |</span><br><span class="line">+------+------------+--------+</span><br></pre></td></tr></table></figure>
<p>按题目中的条件应该输出的是5，6，7，8，但是这样写只输出了5和6，即[5,6,7]和[6,7,8]这两个连续三天中的最小的天数id，<br>原因在于<code>(a.id = b.id-1 and b.id = c.id-1)</code>把a设为了三个连续值中的最小值，因此需要改变这个写法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.*</span><br><span class="line"><span class="keyword">FROM</span> stadium <span class="keyword">as</span> a,stadium <span class="keyword">as</span> b,stadium <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">where</span> a.people&gt;=<span class="number">100</span> <span class="keyword">and</span> b.people&gt;=<span class="number">100</span> <span class="keyword">and</span> c.people&gt;=<span class="number">100</span></span><br><span class="line"><span class="keyword">and</span>(</span><br><span class="line">   (a.id = b.id<span class="number">-1</span> <span class="keyword">and</span> b.id = c.id<span class="number">-1</span>)  <span class="comment">-- a,b,c</span></span><br><span class="line"><span class="keyword">or</span> (b.id = a.id<span class="number">-1</span> <span class="keyword">and</span> a.id = c.id<span class="number">-1</span>)  <span class="comment">-- b,a,c</span></span><br><span class="line"><span class="keyword">or</span> (c.id = b.id<span class="number">-1</span> <span class="keyword">and</span> b.id = a.id<span class="number">-1</span>)  <span class="comment">-- c,b,a</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>得到结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------+------------+--------+</span><br><span class="line">| id   | visit_date | people |</span><br><span class="line">+------+------------+--------+</span><br><span class="line">|    7 | 2017-01-07 |    199 |</span><br><span class="line">|    8 | 2017-01-08 |    188 |</span><br><span class="line">|    6 | 2017-01-06 |   1455 |</span><br><span class="line">|    5 | 2017-01-05 |    145 |</span><br><span class="line">|    7 | 2017-01-07 |    199 |</span><br><span class="line">|    6 | 2017-01-06 |   1455 |</span><br><span class="line">+------+------------+--------+</span><br></pre></td></tr></table></figure>
<p>可以看出[5,6,7]和[6,7,8]这两个连续超过100人数三次的，6和7重复出现了一次，因此再对这个结果去重</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> a.*</span><br><span class="line"><span class="keyword">FROM</span> stadium <span class="keyword">as</span> a,stadium <span class="keyword">as</span> b,stadium <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">where</span> a.people&gt;=<span class="number">100</span> <span class="keyword">and</span> b.people&gt;=<span class="number">100</span> <span class="keyword">and</span> c.people&gt;=<span class="number">100</span></span><br><span class="line"><span class="keyword">and</span>(</span><br><span class="line">   (a.id = b.id<span class="number">-1</span> <span class="keyword">and</span> b.id = c.id<span class="number">-1</span>)  <span class="comment">-- a,b,c   a是第一天</span></span><br><span class="line"><span class="keyword">or</span> (b.id = a.id<span class="number">-1</span> <span class="keyword">and</span> a.id = c.id<span class="number">-1</span>)  <span class="comment">-- b,a,c   a是第二天</span></span><br><span class="line"><span class="keyword">or</span> (c.id = b.id<span class="number">-1</span> <span class="keyword">and</span> b.id = a.id<span class="number">-1</span>)  <span class="comment">-- c,b,a   a是第三天</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a.id;</span><br></pre></td></tr></table></figure>

<h3 id="569-Median-Employee-Salary-员工薪水中位数"><a href="#569-Median-Employee-Salary-员工薪水中位数" class="headerlink" title="569    Median Employee Salary    员工薪水中位数"></a>569    Median Employee Salary    员工薪水中位数</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">The Employee table holds all employees. The employee table has three columns: Employee Id, Company Name, and Salary.</span><br><span class="line">+-----+------------+--------+</span><br><span class="line">|Id   | Company    | Salary |</span><br><span class="line">+-----+------------+--------+</span><br><span class="line">|1    | A          | 2341   |</span><br><span class="line">|2    | A          | 341    |</span><br><span class="line">|3    | A          | 15     |</span><br><span class="line">|4    | A          | 15314  |</span><br><span class="line">|5    | A          | 451    |</span><br><span class="line">|6    | A          | 513    |</span><br><span class="line">|7    | B          | 15     |</span><br><span class="line">|8    | B          | 13     |</span><br><span class="line">|9    | B          | 1154   |</span><br><span class="line">|10   | B          | 1345   |</span><br><span class="line">|11   | B          | 1221   |</span><br><span class="line">|12   | B          | 234    |</span><br><span class="line">|13   | C          | 2345   |</span><br><span class="line">|14   | C          | 2645   |</span><br><span class="line">|15   | C          | 2645   |</span><br><span class="line">|16   | C          | 2652   |</span><br><span class="line">|17   | C          | 65     |</span><br><span class="line">+-----+------------+--------+</span><br><span class="line">Write a SQL query to find the median salary of each company. </span><br><span class="line">Bonus points if you can solve it without using any built-in SQL functions.</span><br><span class="line">+-----+------------+--------+</span><br><span class="line">|Id   | Company    | Salary |</span><br><span class="line">+-----+------------+--------+</span><br><span class="line">|5    | A          | 451    |</span><br><span class="line">|6    | A          | 513    |</span><br><span class="line">|12   | B          | 234    |</span><br><span class="line">|9    | B          | 1154   |</span><br><span class="line">|14   | C          | 2645   |</span><br><span class="line">+-----+------------+--------+</span><br></pre></td></tr></table></figure>

<p>解题思路：先把公司分组，然后算一下每组公司的员工数量，把工资排序，取中位数的工资。这道题本来以为简单的，结果写了半天都没写对。。还是看别人写的。</p>
<p>主要在于中位数的判断。看别人的解题思路，中位数的特点在于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ABS(所有大于等于中位数的数字的数量 - 所有小于等于中位数的数字的数量) &lt;&#x3D; 1</span><br></pre></td></tr></table></figure>

<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * </span><br><span class="line"><span class="keyword">FROM</span> employee <span class="keyword">AS</span> E</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">ABS</span>(</span><br><span class="line">	(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">Id</span>) <span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E1 <span class="keyword">WHERE</span> E1.Company = E.Company <span class="keyword">AND</span> E1.Salary &lt;= E.Salary)</span><br><span class="line">    -</span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">Id</span>) <span class="keyword">FROM</span> Employee <span class="keyword">AS</span> E2 <span class="keyword">WHERE</span> E2.Company = E.Company <span class="keyword">AND</span> E2.Salary &gt;= E.Salary)</span><br><span class="line">	) &lt;= <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Company, Salary;</span><br></pre></td></tr></table></figure>

<h3 id="571-Find-Median-Given-Frequency-of-Numbers-给定数字的频率查询中位数"><a href="#571-Find-Median-Given-Frequency-of-Numbers-给定数字的频率查询中位数" class="headerlink" title="571    Find Median Given Frequency of Numbers     给定数字的频率查询中位数"></a>571    Find Median Given Frequency of Numbers     给定数字的频率查询中位数</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">The Numbers table keeps the value of number and its frequency.</span><br><span class="line"></span><br><span class="line">+----------+-------------+</span><br><span class="line">|  Number  |  Frequency  |</span><br><span class="line">+----------+-------------|</span><br><span class="line">|  0       |  7          |</span><br><span class="line">|  1       |  1          |</span><br><span class="line">|  2       |  3          |</span><br><span class="line">|  3       |  1          |</span><br><span class="line">+----------+-------------+</span><br><span class="line">In this table, the numbers are 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 3, so the median is (0 + 0) &#x2F; 2 &#x3D; 0.</span><br><span class="line"></span><br><span class="line">+--------+</span><br><span class="line">| median |</span><br><span class="line">+--------|</span><br><span class="line">| 0.0000 |</span><br><span class="line">+--------+</span><br><span class="line">Write a query to find the median of all numbers and name the result as median.</span><br></pre></td></tr></table></figure>

<p>解题思路：这个还没搞懂，代码抄别人的。。</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">AVG</span>(n.Number) <span class="keyword">AS</span> <span class="keyword">median</span></span><br><span class="line"><span class="keyword">FROM</span> Numbers n</span><br><span class="line"><span class="keyword">WHERE</span> n.Frequency &gt;= <span class="keyword">ABS</span>((<span class="keyword">SELECT</span> <span class="keyword">SUM</span>(Frequency) <span class="keyword">FROM</span> Numbers <span class="keyword">WHERE</span> <span class="built_in">Number</span> &lt;= n.Number) -</span><br><span class="line">                         (<span class="keyword">SELECT</span> <span class="keyword">SUM</span>(Frequency) <span class="keyword">FROM</span> Numbers <span class="keyword">WHERE</span> <span class="built_in">Number</span> &gt;= n.Number))</span><br></pre></td></tr></table></figure>

<h3 id="579-Find-Cumulative-Salary-of-an-Employee-查询员工的累计薪水"><a href="#579-Find-Cumulative-Salary-of-an-Employee-查询员工的累计薪水" class="headerlink" title="579    Find Cumulative Salary of an Employee  查询员工的累计薪水"></a>579    Find Cumulative Salary of an Employee  查询员工的累计薪水</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">The Employee table holds the salary information in a year.</span><br><span class="line"></span><br><span class="line">Write a SQL to get the cumulative sum of an employee&#39;s salary over a period of 3 months but exclude the most recent month.</span><br><span class="line"></span><br><span class="line">The result should be displayed by &#39;Id&#39; ascending, and then by &#39;Month&#39; descending.</span><br><span class="line"></span><br><span class="line">Example</span><br><span class="line">Input</span><br><span class="line"></span><br><span class="line">| Id | Month | Salary |</span><br><span class="line">|----|-------|--------|</span><br><span class="line">| 1  | 1     | 20     |</span><br><span class="line">| 2  | 1     | 20     |</span><br><span class="line">| 1  | 2     | 30     |</span><br><span class="line">| 2  | 2     | 30     |</span><br><span class="line">| 3  | 2     | 40     |</span><br><span class="line">| 1  | 3     | 40     |</span><br><span class="line">| 3  | 3     | 60     |</span><br><span class="line">| 1  | 4     | 60     |</span><br><span class="line">| 3  | 4     | 70     |</span><br><span class="line">Output</span><br><span class="line"></span><br><span class="line">| Id | Month | Salary |</span><br><span class="line">|----|-------|--------|</span><br><span class="line">| 1  | 3     | 90     |</span><br><span class="line">| 1  | 2     | 50     |</span><br><span class="line">| 1  | 1     | 20     |</span><br><span class="line">| 2  | 1     | 20     |</span><br><span class="line">| 3  | 3     | 100    |</span><br><span class="line">| 3  | 2     | 40     |</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Explanation</span><br><span class="line">Employee &#39;1&#39; has 3 salary records for the following 3 months except the most recent month &#39;4&#39;: salary 40 for month &#39;3&#39;, 30 for month &#39;2&#39; and 20 for month &#39;1&#39;</span><br><span class="line">So the cumulative sum of salary of this employee over 3 months is 90(40+30+20), 50(30+20) and 20 respectively.</span><br><span class="line"></span><br><span class="line">| Id | Month | Salary |</span><br><span class="line">|----|-------|--------|</span><br><span class="line">| 1  | 3     | 90     |</span><br><span class="line">| 1  | 2     | 50     |</span><br><span class="line">| 1  | 1     | 20     |</span><br><span class="line">Employee &#39;2&#39; only has one salary record (month &#39;1&#39;) except its most recent month &#39;2&#39;.</span><br><span class="line">| Id | Month | Salary |</span><br><span class="line">|----|-------|--------|</span><br><span class="line">| 2  | 1     | 20     |</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Employ &#39;3&#39; has two salary records except its most recent pay month &#39;4&#39;: month &#39;3&#39; with 60 and month &#39;2&#39; with 40. So the cumulative salary is as following.</span><br><span class="line">| Id | Month | Salary |</span><br><span class="line">|----|-------|--------|</span><br><span class="line">| 3  | 3     | 100    |</span><br><span class="line">| 3  | 2     | 40     |</span><br></pre></td></tr></table></figure>

<p>解题思路：</p>
<p>通过代码：</p>
<p>第一种方法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.id, </span><br><span class="line">    a.month,</span><br><span class="line">    <span class="keyword">SUM</span>(b.salary) Salary</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    Employee a <span class="keyword">JOIN</span> Employee b <span class="keyword">ON</span></span><br><span class="line">    a.id = b.id <span class="keyword">AND</span></span><br><span class="line">    a.month - b.month &gt;= <span class="number">0</span> <span class="keyword">AND</span></span><br><span class="line">    a.month - b.month &lt; <span class="number">3</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    a.id, a.month</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">    (a.id, a.month) <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">MAX</span>(<span class="keyword">month</span>) <span class="keyword">FROM</span> Employee <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">id</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    a.id, a.month <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<p>第二种方法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.Id, <span class="keyword">MAX</span>(e2.Month) <span class="keyword">AS</span> <span class="keyword">Month</span>, <span class="keyword">SUM</span>(e2.Salary) <span class="keyword">AS</span> Salary</span><br><span class="line"><span class="keyword">FROM</span> Employee e1, Employee e2</span><br><span class="line"><span class="keyword">WHERE</span> e1.Id = e2.Id <span class="keyword">AND</span> e2.Month <span class="keyword">BETWEEN</span> (e1.Month - <span class="number">3</span>) <span class="keyword">AND</span> (e1.Month - <span class="number">1</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> e1.Id, e1.Month</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">Id</span>, <span class="keyword">Month</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="615-Average-Salary-Departments-VS-Company-平均工资：部门与公司比较"><a href="#615-Average-Salary-Departments-VS-Company-平均工资：部门与公司比较" class="headerlink" title="615    Average Salary: Departments VS Company 平均工资：部门与公司比较"></a>615    Average Salary: Departments VS Company 平均工资：部门与公司比较</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Given two tables as below, write a query to display the comparison result (higher&#x2F;lower&#x2F;same) of the average salary of employees in a department to the company&#39;s average salary.</span><br><span class="line"> </span><br><span class="line">Table: salary</span><br><span class="line">| id | employee_id | amount | pay_date   |</span><br><span class="line">|----|-------------|--------|------------|</span><br><span class="line">| 1  | 1           | 9000   | 2017-03-31 |</span><br><span class="line">| 2  | 2           | 6000   | 2017-03-31 |</span><br><span class="line">| 3  | 3           | 10000  | 2017-03-31 |</span><br><span class="line">| 4  | 1           | 7000   | 2017-02-28 |</span><br><span class="line">| 5  | 2           | 6000   | 2017-02-28 |</span><br><span class="line">| 6  | 3           | 8000   | 2017-02-28 |</span><br><span class="line"></span><br><span class="line">The employee_id column refers to the employee_id in the following table employee.</span><br><span class="line"></span><br><span class="line">| employee_id | department_id |</span><br><span class="line">|-------------|---------------|</span><br><span class="line">| 1           | 1             |</span><br><span class="line">| 2           | 2             |</span><br><span class="line">| 3           | 2             |</span><br><span class="line"> </span><br><span class="line">So for the sample data above, the result is:</span><br><span class="line"></span><br><span class="line">| pay_month | department_id | comparison  |</span><br><span class="line">|-----------|---------------|-------------|</span><br><span class="line">| 2017-03   | 1             | higher      |</span><br><span class="line">| 2017-03   | 2             | lower       |</span><br><span class="line">| 2017-02   | 1             | same        |</span><br><span class="line">| 2017-02   | 2             | same        |</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Explanation</span><br><span class="line"> </span><br><span class="line">In March, the company&#39;s average salary is (9000+6000+10000)&#x2F;3 &#x3D; 8333.33...</span><br><span class="line"></span><br><span class="line">The average salary for department &#39;1&#39; is 9000, which is the salary of employee_id &#39;1&#39; since there is only one employee in this department. So the comparison result is &#39;higher&#39; since 9000 &gt; 8333.33 obviously.</span><br><span class="line"> </span><br><span class="line">The average salary of department &#39;2&#39; is (6000 + 10000)&#x2F;2 &#x3D; 8000, which is the average of employee_id &#39;2&#39; and &#39;3&#39;. So the comparison result is &#39;lower&#39; since 8000 &lt; 8333.33.</span><br><span class="line"></span><br><span class="line">With he same formula for the average salary comparison in February, the result is &#39;same&#39; since both the department &#39;1&#39; and &#39;2&#39; have the same average salary with the company, which is 7000.</span><br></pre></td></tr></table></figure>

<p>解题思路：显示部门员工平均工资与公司平均工资的比较结果(更高/更低/相同)。</p>
<p>那么先找出公司每个月的平均工资：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *, <span class="keyword">AVG</span>(amount) <span class="keyword">AS</span> <span class="string">`avg_salary`</span></span><br><span class="line"><span class="keyword">FROM</span> salary <span class="keyword">AS</span> s <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e</span><br><span class="line"><span class="keyword">ON</span> s.employee_id = e.employee_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">LEFT</span>(s.pay_date, <span class="number">7</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">LEFT</span>(s.pay_date, <span class="number">7</span>) <span class="keyword">DESC</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+------+-------------+--------+------------+-------------+---------------+------------+</span><br><span class="line">| id   | employee_id | amount | pay_date   | employee_id | department_id | avg_salary |</span><br><span class="line">+------+-------------+--------+------------+-------------+---------------+------------+</span><br><span class="line">|    1 |           1 |   9000 | 2017-03-31 |           1 |             1 |  8333.3333 |</span><br><span class="line">|    4 |           1 |   7000 | 2017-02-28 |           1 |             1 |  7000.0000 |</span><br><span class="line">+------+-------------+--------+------------+-------------+---------------+------------+</span><br></pre></td></tr></table></figure>

<p>然后找每个部门的每月平均工资：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *,  <span class="keyword">AVG</span>(amount) <span class="keyword">AS</span> <span class="string">`dept_avg_salary`</span></span><br><span class="line"><span class="keyword">FROM</span> salary <span class="keyword">AS</span> s <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e </span><br><span class="line"><span class="keyword">ON</span> s.employee_id = e.employee_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">LEFT</span>(s.pay_date, <span class="number">7</span>), e.department_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">LEFT</span>(s.pay_date, <span class="number">7</span>) <span class="keyword">DESC</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+------+-------------+--------+------------+-------------+---------------+-----------------+</span><br><span class="line">| id   | employee_id | amount | pay_date   | employee_id | department_id | dept_avg_salary |</span><br><span class="line">+------+-------------+--------+------------+-------------+---------------+-----------------+</span><br><span class="line">|    1 |           1 |   9000 | 2017-03-31 |           1 |             1 |       9000.0000 |</span><br><span class="line">|    2 |           2 |   6000 | 2017-03-31 |           2 |             2 |       8000.0000 |</span><br><span class="line">|    4 |           1 |   7000 | 2017-02-28 |           1 |             1 |       7000.0000 |</span><br><span class="line">|    5 |           2 |   6000 | 2017-02-28 |           2 |             2 |       7000.0000 |</span><br><span class="line">+------+-------------+--------+------------+-------------+---------------+-----------------+</span><br></pre></td></tr></table></figure>

<p>然后把这两个表连接起来,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * </span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">DATE_FORMAT</span>(pay_date, <span class="string">'%Y-%m'</span>) <span class="keyword">AS</span> pay_month, <span class="keyword">AVG</span>(amount) <span class="keyword">AS</span> <span class="string">`avg_salary`</span></span><br><span class="line">	<span class="keyword">FROM</span> salary <span class="keyword">AS</span> s <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e</span><br><span class="line">	<span class="keyword">ON</span> s.employee_id = e.employee_id</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> pay_month </span><br><span class="line">) <span class="keyword">AS</span> A</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">(</span><br><span class="line">	<span class="keyword">SELECT</span> e.department_id, <span class="keyword">DATE_FORMAT</span>(pay_date, <span class="string">'%Y-%m'</span>) <span class="keyword">AS</span> pay_month, <span class="keyword">AVG</span>(amount) <span class="keyword">AS</span> <span class="string">`dept_avg_salary`</span></span><br><span class="line">	<span class="keyword">FROM</span> salary <span class="keyword">AS</span> s <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e </span><br><span class="line">	<span class="keyword">ON</span> s.employee_id = e.employee_id</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> pay_month, e.department_id</span><br><span class="line">) <span class="keyword">AS</span> B</span><br><span class="line"><span class="keyword">ON</span> A.pay_month = B.pay_month</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> B.pay_month <span class="keyword">DESC</span>, B.department_id;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-----------+------------+---------------+-----------+-----------------+</span><br><span class="line">| pay_month | avg_salary | department_id | pay_month | dept_avg_salary |</span><br><span class="line">+-----------+------------+---------------+-----------+-----------------+</span><br><span class="line">| 2017-03   |  8333.3333 |             1 | 2017-03   |       9000.0000 |</span><br><span class="line">| 2017-03   |  8333.3333 |             2 | 2017-03   |       8000.0000 |</span><br><span class="line">| 2017-02   |  7000.0000 |             1 | 2017-02   |       7000.0000 |</span><br><span class="line">| 2017-02   |  7000.0000 |             2 | 2017-02   |       7000.0000 |</span><br><span class="line">+-----------+------------+---------------+-----------+-----------------+</span><br></pre></td></tr></table></figure>
<p>最后，对这张表做比较，使用CASE WHEN语句来实现高于，低于，等于的判断。</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> B.pay_month,</span><br><span class="line">	   B.department_id,</span><br><span class="line">       <span class="keyword">CASE</span></span><br><span class="line">			<span class="keyword">WHEN</span> B.dept_avg_salary &gt; A.avg_salary <span class="keyword">THEN</span> <span class="string">'higher'</span></span><br><span class="line">			<span class="keyword">WHEN</span> B.dept_avg_salary &lt; A.avg_salary <span class="keyword">THEN</span> <span class="string">'lower'</span></span><br><span class="line">			<span class="keyword">ELSE</span> <span class="string">'same'</span></span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">AS</span> <span class="string">'comparison'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">DATE_FORMAT</span>(pay_date, <span class="string">'%Y-%m'</span>) <span class="keyword">AS</span> pay_month, <span class="keyword">AVG</span>(amount) <span class="keyword">AS</span> <span class="string">`avg_salary`</span></span><br><span class="line">	<span class="keyword">FROM</span> salary <span class="keyword">AS</span> s <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e</span><br><span class="line">	<span class="keyword">ON</span> s.employee_id = e.employee_id</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> pay_month </span><br><span class="line">) <span class="keyword">AS</span> A</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">(</span><br><span class="line">	<span class="keyword">SELECT</span> e.department_id, <span class="keyword">DATE_FORMAT</span>(pay_date, <span class="string">'%Y-%m'</span>) <span class="keyword">AS</span> pay_month, <span class="keyword">AVG</span>(amount) <span class="keyword">AS</span> <span class="string">`dept_avg_salary`</span></span><br><span class="line">	<span class="keyword">FROM</span> salary <span class="keyword">AS</span> s <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e </span><br><span class="line">	<span class="keyword">ON</span> s.employee_id = e.employee_id</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> pay_month, e.department_id</span><br><span class="line">) <span class="keyword">AS</span> B</span><br><span class="line"><span class="keyword">ON</span> A.pay_month = B.pay_month</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> B.pay_month <span class="keyword">DESC</span>, B.department_id;</span><br></pre></td></tr></table></figure>

<h3 id="618-Students-Report-By-Geography-学生地理信息报告"><a href="#618-Students-Report-By-Geography-学生地理信息报告" class="headerlink" title="618    Students Report By Geography 学生地理信息报告"></a>618    Students Report By Geography 学生地理信息报告</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">A U.S graduate school has students from Asia, Europe and America. The students&#39; location information are stored in table student as below.</span><br><span class="line"></span><br><span class="line">| name   | continent |</span><br><span class="line">|--------|-----------|</span><br><span class="line">| Jack   | America   |</span><br><span class="line">| Pascal | Europe    |</span><br><span class="line">| Xi     | Asia      |</span><br><span class="line">| Jane   | America   |</span><br><span class="line"></span><br><span class="line">Pivot the continent column in this table so that each name is sorted alphabetically and displayed underneath its corresponding continent. The output headers should be America, Asia and Europe respectively. </span><br><span class="line">It is guaranteed that the student number from America is no less than either Asia or Europe.</span><br><span class="line"></span><br><span class="line">For the sample input, the output is:</span><br><span class="line"></span><br><span class="line">| America | Asia | Europe |</span><br><span class="line">|---------|------|--------|</span><br><span class="line">| Jack    | Xi   | Pascal |</span><br><span class="line">| Jane    |      |        |</span><br><span class="line"> </span><br><span class="line">Follow-up: If it is unknown which continent has the most students, can you write a query to generate the student report?</span><br></pre></td></tr></table></figure>

<p>解题思路：这个是行转列问题，但是我没有思路怎么做。。看网上的方法是这样的</p>
<p>第一种思路，使用自定义变量，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @am := @am + <span class="number">1</span> <span class="keyword">AS</span> row_id, <span class="keyword">name</span> <span class="keyword">AS</span> America</span><br><span class="line"><span class="keyword">FROM</span> student, (<span class="keyword">SELECT</span> @am := <span class="number">0</span>) <span class="keyword">AS</span> init</span><br><span class="line"><span class="keyword">WHERE</span> continent = <span class="string">'America'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span>;</span><br></pre></td></tr></table></figure>
<p>得到结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+--------+---------+</span><br><span class="line">| row_id | America |</span><br><span class="line">+--------+---------+</span><br><span class="line">|      1 | Jack    |</span><br><span class="line">|      2 | Jane    |</span><br><span class="line">+--------+---------+</span><br></pre></td></tr></table></figure>
<p>类似的，得到Asia和Europe地区的，然后将这三张表连接起来</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.name <span class="keyword">AS</span> America, b.name <span class="keyword">AS</span> Asia, c.name <span class="keyword">AS</span> Europe</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> @r1 := @r1 + <span class="number">1</span> <span class="keyword">AS</span> <span class="keyword">id</span>, <span class="keyword">name</span> </span><br><span class="line">    <span class="keyword">FROM</span> student, (<span class="keyword">SELECT</span> @r1 := <span class="number">0</span>) init </span><br><span class="line">    <span class="keyword">WHERE</span> continent = <span class="string">'America'</span> </span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span></span><br><span class="line">) a</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> @r2 := @r2 + <span class="number">1</span> <span class="keyword">AS</span> <span class="keyword">id</span>, <span class="keyword">name</span> </span><br><span class="line">    <span class="keyword">FROM</span> student, (<span class="keyword">SELECT</span> @r2 := <span class="number">0</span>) init </span><br><span class="line">    <span class="keyword">WHERE</span> continent = <span class="string">'Asia'</span> </span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span></span><br><span class="line">) b</span><br><span class="line"><span class="keyword">ON</span> a.id = b.id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> @r3 := @r3 + <span class="number">1</span> <span class="keyword">AS</span> <span class="keyword">id</span>, <span class="keyword">name</span> </span><br><span class="line">    <span class="keyword">FROM</span> student, (<span class="keyword">SELECT</span> @r3 := <span class="number">0</span>) init </span><br><span class="line">    <span class="keyword">WHERE</span> continent = <span class="string">'Europe'</span> </span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span></span><br><span class="line">) c</span><br><span class="line"><span class="keyword">ON</span> a.id = c.id</span><br><span class="line"><span class="keyword">OR</span> b.id = c.id;</span><br></pre></td></tr></table></figure>

<p>第二种思路，使用窗口函数。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> America, Asia, Europe</span><br><span class="line"><span class="keyword">FROM</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> continentorder,</span><br><span class="line">    <span class="keyword">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> continent = <span class="string">'America'</span> <span class="keyword">THEN</span> <span class="keyword">name</span> <span class="keyword">END</span> )<span class="keyword">AS</span> America,</span><br><span class="line">    <span class="keyword">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> continent = <span class="string">'Europe'</span> <span class="keyword">THEN</span> <span class="keyword">name</span> <span class="keyword">END</span> )<span class="keyword">AS</span> Europe,</span><br><span class="line">    <span class="keyword">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> continent = <span class="string">'Asia'</span> <span class="keyword">THEN</span> <span class="keyword">name</span> <span class="keyword">END</span> )<span class="keyword">AS</span> Asia</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> *,</span><br><span class="line">        ROW_NUMBER()<span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> continent <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span>) <span class="keyword">AS</span> continentorder</span><br><span class="line">        <span class="keyword">FROM</span> student</span><br><span class="line">    ) <span class="keyword">AS</span> <span class="keyword">SOURCE</span></span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> continentorder</span><br><span class="line">)temp;</span><br></pre></td></tr></table></figure>

<h3 id="1097-Game-Play-Analysis-V"><a href="#1097-Game-Play-Analysis-V" class="headerlink" title="1097 Game Play Analysis V"></a>1097 Game Play Analysis V</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Table: Activity</span><br><span class="line"></span><br><span class="line">+--------------+---------+</span><br><span class="line">| Column Name  | Type    |</span><br><span class="line">+--------------+---------+</span><br><span class="line">| player_id    | int     |</span><br><span class="line">| device_id    | int     |</span><br><span class="line">| event_date   | date    |</span><br><span class="line">| games_played | int     |</span><br><span class="line">+--------------+---------+</span><br><span class="line">(player_id, event_date) is the primary key of this table.</span><br><span class="line">This table shows the activity of players of some game.</span><br><span class="line">Each row is a record of a player who logged in and played a number of games (possibly 0) before logging out on some day using some device.</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">We define the install date of a player to be the first login day of that player.</span><br><span class="line"></span><br><span class="line">We also define day 1 retention of some date X to be the number of players whose install date is X and they logged back in on the day right after X, divided by the number of players whose install date is X, rounded to 2 decimal places.</span><br><span class="line"></span><br><span class="line">Write an SQL query that reports for each install date, the number of players that installed the game on that day and the day 1 retention.</span><br><span class="line"></span><br><span class="line">The query result format is in the following example:</span><br><span class="line"></span><br><span class="line">Activity table:</span><br><span class="line">+-----------+-----------+------------+--------------+</span><br><span class="line">| player_id | device_id | event_date | games_played |</span><br><span class="line">+-----------+-----------+------------+--------------+</span><br><span class="line">| 1         | 2         | 2016-03-01 | 5            |</span><br><span class="line">| 1         | 2         | 2016-03-02 | 6            |</span><br><span class="line">| 2         | 3         | 2017-06-25 | 1            |</span><br><span class="line">| 3         | 1         | 2016-03-01 | 0            |</span><br><span class="line">| 3         | 4         | 2016-07-03 | 5            |</span><br><span class="line">+-----------+-----------+------------+--------------+</span><br><span class="line"></span><br><span class="line">Result table:</span><br><span class="line">+------------+----------+----------------+</span><br><span class="line">| install_dt | installs | Day1_retention |</span><br><span class="line">+------------+----------+----------------+</span><br><span class="line">| 2016-03-01 | 2        | 0.50           |</span><br><span class="line">| 2017-06-25 | 1        | 0.00           |</span><br><span class="line">+------------+----------+----------------+</span><br><span class="line">Player 1 and 3 installed the game on 2016-03-01 but only player 1 logged back in on 2016-03-02 so the day 1 retention of 2016-03-01 is 1 &#x2F; 2 &#x3D; 0.50</span><br><span class="line">Player 2 installed the game on 2017-06-25 but didn&#39;t log back in on 2017-06-26 so the day 1 retention of 2017-06-25 is 0 &#x2F; 1 &#x3D; 0.00</span><br></pre></td></tr></table></figure>

<p>解题思路：找出每个玩家的安装日期，以及安装日期后的一日留存。</p>
<p>首先找出每个玩家的安装日期，即第一次登陆的日期，对玩家分组，求每组的最小日期。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> player_id, <span class="keyword">MIN</span>(event_date) <span class="keyword">AS</span> <span class="string">'install_dt'</span></span><br><span class="line"><span class="keyword">FROM</span> Activity</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id;</span><br></pre></td></tr></table></figure>
<p>得到每个玩家的按照日期：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-----------+------------+</span><br><span class="line">| player_id | install_dt |</span><br><span class="line">+-----------+------------+</span><br><span class="line">|         1 | 2016-03-01 |</span><br><span class="line">|         2 | 2017-06-25 |</span><br><span class="line">|         3 | 2016-03-01 |</span><br><span class="line">+-----------+------------+</span><br></pre></td></tr></table></figure>
<p>然后将这个表和原表连接，统计每个玩家第二天登陆的情况，因为存在第二天玩家没有登陆，因此，使用左连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> player_id, <span class="keyword">MIN</span>(event_date) <span class="keyword">AS</span> <span class="string">'install_dt'</span></span><br><span class="line">        <span class="keyword">FROM</span> Activity</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id</span><br><span class="line">    ) <span class="keyword">AS</span> A </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Activity <span class="keyword">AS</span> B </span><br><span class="line"><span class="keyword">ON</span> A.player_id = B.player_id</span><br><span class="line"><span class="keyword">AND</span> B.event_date = <span class="keyword">DATE_ADD</span>(A.install_dt, <span class="built_in">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>);</span><br></pre></td></tr></table></figure>
<p>得到结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-----------+------------+-----------+-----------+------------+--------------+</span><br><span class="line">| player_id | install_dt | player_id | device_id | event_date | games_played |</span><br><span class="line">+-----------+------------+-----------+-----------+------------+--------------+</span><br><span class="line">|         1 | 2016-03-01 |         1 |         2 | 2016-03-02 |            6 |</span><br><span class="line">|         2 | 2017-06-25 |      NULL |      NULL | NULL       |         NULL |</span><br><span class="line">|         3 | 2016-03-01 |      NULL |      NULL | NULL       |         NULL |</span><br><span class="line">+-----------+------------+-----------+-----------+------------+--------------+</span><br></pre></td></tr></table></figure>
<p>有了这个结果后，计算一日留存率，即首日安装后第二天又登陆的玩家 / 首日安装的所有玩家</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> install_dt, <span class="keyword">COUNT</span>(player_id) <span class="keyword">AS</span> installs,</span><br><span class="line">	   <span class="keyword">ROUND</span>( <span class="keyword">COUNT</span>(next_day) / <span class="keyword">COUNT</span>(player_id), <span class="number">2</span> ) <span class="keyword">AS</span> Day1_retention</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> A.player_id, A.install_dt, B.event_date <span class="keyword">AS</span> <span class="string">'next_day'</span></span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> player_id, <span class="keyword">MIN</span>(event_date) <span class="keyword">AS</span> <span class="string">'install_dt'</span></span><br><span class="line">			<span class="keyword">FROM</span> Activity</span><br><span class="line">			<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id</span><br><span class="line">		) <span class="keyword">AS</span> A </span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Activity <span class="keyword">AS</span> B </span><br><span class="line">	<span class="keyword">ON</span> A.player_id = B.player_id</span><br><span class="line">	<span class="keyword">AND</span> B.event_date = <span class="keyword">DATE_ADD</span>(A.install_dt,<span class="built_in">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>)</span><br><span class="line">) <span class="keyword">AS</span> t</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> install_dt;</span><br></pre></td></tr></table></figure>

<h3 id="1127-User-Purchase-Platform"><a href="#1127-User-Purchase-Platform" class="headerlink" title="1127 User Purchase Platform"></a>1127 User Purchase Platform</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Table: Spending</span><br><span class="line"></span><br><span class="line">+-------------+---------+</span><br><span class="line">| Column Name | Type    |</span><br><span class="line">+-------------+---------+</span><br><span class="line">| user_id     | int     |</span><br><span class="line">| spend_date  | date    |</span><br><span class="line">| platform    | enum    | </span><br><span class="line">| amount      | int     |</span><br><span class="line">+-------------+---------+</span><br><span class="line">The table logs the spendings history of users that make purchases from an online shopping website which has a desktop and a mobile application.</span><br><span class="line">(user_id, spend_date, platform) is the primary key of this table.</span><br><span class="line">The platform column is an ENUM type of (&#39;desktop&#39;, &#39;mobile&#39;).</span><br><span class="line">Write an SQL query to find the total number of users and the total amount spent using mobile only, desktop only and both mobile and desktop together for each date.</span><br><span class="line"></span><br><span class="line">The query result format is in the following example:</span><br><span class="line"></span><br><span class="line">Spending table:</span><br><span class="line">+---------+------------+----------+--------+</span><br><span class="line">| user_id | spend_date | platform | amount |</span><br><span class="line">+---------+------------+----------+--------+</span><br><span class="line">| 1       | 2019-07-01 | mobile   | 100    |</span><br><span class="line">| 1       | 2019-07-01 | desktop  | 100    |</span><br><span class="line">| 2       | 2019-07-01 | mobile   | 100    |</span><br><span class="line">| 2       | 2019-07-02 | mobile   | 100    |</span><br><span class="line">| 3       | 2019-07-01 | desktop  | 100    |</span><br><span class="line">| 3       | 2019-07-02 | desktop  | 100    |</span><br><span class="line">+---------+------------+----------+--------+</span><br><span class="line"></span><br><span class="line">Result table:</span><br><span class="line">+------------+----------+--------------+-------------+</span><br><span class="line">| spend_date | platform | total_amount | total_users |</span><br><span class="line">+------------+----------+--------------+-------------+</span><br><span class="line">| 2019-07-01 | desktop  | 100          | 1           |</span><br><span class="line">| 2019-07-01 | mobile   | 100          | 1           |</span><br><span class="line">| 2019-07-01 | both     | 200          | 1           |</span><br><span class="line">| 2019-07-02 | desktop  | 100          | 1           |</span><br><span class="line">| 2019-07-02 | mobile   | 100          | 1           |</span><br><span class="line">| 2019-07-02 | both     | 0            | 0           |</span><br><span class="line">+------------+----------+--------------+-------------+ </span><br><span class="line">On 2019-07-01, user 1 purchased using both desktop and mobile, user 2 purchased using mobile only and user 3 purchased using desktop only.</span><br><span class="line">On 2019-07-02, user 2 purchased using mobile only,  user 3 purchased using desktop only and no one purchased using both platforms.</span><br></pre></td></tr></table></figure>

<p>解题思路：</p>
<p>首先按照spend_date和user_id分组，统计平台信息，如果两个平台都有，就设为both</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">        spend_date,</span><br><span class="line">        user_id,</span><br><span class="line">        (<span class="keyword">CASE</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> platform)</span><br><span class="line">              <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> platform</span><br><span class="line">              <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">'both'</span></span><br><span class="line">         <span class="keyword">END</span>) <span class="keyword">AS</span> platform,</span><br><span class="line">         <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> amount</span><br><span class="line"><span class="keyword">FROM</span> spending</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> spend_date, user_id;</span><br></pre></td></tr></table></figure>
<p>得到结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+------------+---------+----------+--------+</span><br><span class="line">| spend_date | user_id | platform | amount |</span><br><span class="line">+------------+---------+----------+--------+</span><br><span class="line">| 2019-07-01 |       1 | both     |    200 |</span><br><span class="line">| 2019-07-01 |       2 | mobile   |    100 |</span><br><span class="line">| 2019-07-01 |       3 | desktop  |    100 |</span><br><span class="line">| 2019-07-02 |       2 | mobile   |    100 |</span><br><span class="line">| 2019-07-02 |       3 | desktop  |    100 |</span><br><span class="line">+------------+---------+----------+--------+</span><br></pre></td></tr></table></figure>
<p>然后统计每天对应平台的总量和总用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> spend_date,</span><br><span class="line">       platform,</span><br><span class="line">       <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> total_amount,</span><br><span class="line">       <span class="keyword">COUNT</span>(user_id) <span class="keyword">AS</span> total_users</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        spend_date,</span><br><span class="line">        user_id,</span><br><span class="line">        (<span class="keyword">CASE</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> platform)</span><br><span class="line">              <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> platform</span><br><span class="line">              <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">'both'</span></span><br><span class="line">         <span class="keyword">END</span>) <span class="keyword">AS</span> platform,</span><br><span class="line">         <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> amount</span><br><span class="line">    <span class="keyword">FROM</span> spending</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> spend_date, user_id</span><br><span class="line">    ) <span class="keyword">AS</span> b</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> spend_date, platform;</span><br></pre></td></tr></table></figure>
<p>得到结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+------------+----------+--------------+-------------+</span><br><span class="line">| spend_date | platform | total_amount | total_users |</span><br><span class="line">+------------+----------+--------------+-------------+</span><br><span class="line">| 2019-07-01 | both     |          200 |           1 |</span><br><span class="line">| 2019-07-01 | desktop  |          100 |           1 |</span><br><span class="line">| 2019-07-01 | mobile   |          100 |           1 |</span><br><span class="line">| 2019-07-02 | desktop  |          100 |           1 |</span><br><span class="line">| 2019-07-02 | mobile   |          100 |           1 |</span><br><span class="line">+------------+----------+--------------+-------------+</span><br></pre></td></tr></table></figure>
<p>这个结果和题目中给出的结果表还差对7-2日both结果的统计，因此做出来一个如下的表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">'desktop'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">'mobile'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">'both'</span> <span class="keyword">AS</span> platform;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| platform |</span><br><span class="line">+----------+</span><br><span class="line">| desktop  |</span><br><span class="line">| mobile   |</span><br><span class="line">| both     |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure>
<p>连接表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(spend_date), a.platform   </span><br><span class="line"><span class="keyword">FROM</span> Spending <span class="keyword">JOIN</span></span><br><span class="line">    (   <span class="keyword">SELECT</span> <span class="string">'desktop'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">'mobile'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">'both'</span> <span class="keyword">AS</span> platform</span><br><span class="line">    ) <span class="keyword">AS</span> a</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+----------+</span><br><span class="line">| spend_date | platform |</span><br><span class="line">+------------+----------+</span><br><span class="line">| 2019-07-01 | desktop  |</span><br><span class="line">| 2019-07-01 | mobile   |</span><br><span class="line">| 2019-07-01 | both     |</span><br><span class="line">| 2019-07-02 | desktop  |</span><br><span class="line">| 2019-07-02 | mobile   |</span><br><span class="line">| 2019-07-02 | both     |</span><br><span class="line">+------------+----------+</span><br></pre></td></tr></table></figure>

<p>再连接这两张大表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(spend_date), a.platform   <span class="comment">-- table aa</span></span><br><span class="line">    <span class="keyword">FROM</span> Spending <span class="keyword">JOIN</span></span><br><span class="line">        (   <span class="keyword">SELECT</span> <span class="string">'desktop'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line">            <span class="keyword">SELECT</span> <span class="string">'mobile'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line">            <span class="keyword">SELECT</span> <span class="string">'both'</span> <span class="keyword">AS</span> platform</span><br><span class="line">        ) <span class="keyword">AS</span> a </span><br><span class="line">) <span class="keyword">AS</span> ta</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> spend_date,</span><br><span class="line">       platform,</span><br><span class="line">       <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> total_amount,</span><br><span class="line">       <span class="keyword">COUNT</span>(user_id) <span class="keyword">AS</span> total_users</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> </span><br><span class="line">            spend_date,</span><br><span class="line">            user_id,</span><br><span class="line">            (<span class="keyword">CASE</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> platform)</span><br><span class="line">                <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> platform</span><br><span class="line">                <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">'both'</span></span><br><span class="line">            <span class="keyword">END</span>) <span class="keyword">AS</span> platform,</span><br><span class="line">            <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> amount</span><br><span class="line">        <span class="keyword">FROM</span> spending</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> spend_date, user_id</span><br><span class="line">    ) <span class="keyword">AS</span> b</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> spend_date, platform</span><br><span class="line">) <span class="keyword">as</span> tb</span><br><span class="line"><span class="keyword">ON</span> ta.platform = tb.platform</span><br><span class="line"><span class="keyword">AND</span> ta.spend_date = tb.spend_date;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+----------+------------+----------+--------------+-------------+</span><br><span class="line">| spend_date | platform | spend_date | platform | total_amount | total_users |</span><br><span class="line">+------------+----------+------------+----------+--------------+-------------+</span><br><span class="line">| 2019-07-01 | both     | 2019-07-01 | both     |          200 |           1 |</span><br><span class="line">| 2019-07-01 | desktop  | 2019-07-01 | desktop  |          100 |           1 |</span><br><span class="line">| 2019-07-01 | mobile   | 2019-07-01 | mobile   |          100 |           1 |</span><br><span class="line">| 2019-07-02 | desktop  | 2019-07-02 | desktop  |          100 |           1 |</span><br><span class="line">| 2019-07-02 | mobile   | 2019-07-02 | mobile   |          100 |           1 |</span><br><span class="line">| 2019-07-02 | both     | NULL       | NULL     |         NULL |        NULL |</span><br><span class="line">+------------+----------+------------+----------+--------------+-------------+</span><br></pre></td></tr></table></figure>

<p>最后，在这张表中，按照题目要求取出相应的值，其中null转化为0，</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    ta.spend_date,</span><br><span class="line">    ta.platform,</span><br><span class="line">    <span class="keyword">COALESCE</span>(tb.total_amount, <span class="number">0</span>) <span class="keyword">AS</span> total_amount,</span><br><span class="line">    <span class="keyword">COALESCE</span>(tb.total_users, <span class="number">0</span>) <span class="keyword">AS</span> total_users</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(spend_date), a.platform   <span class="comment">-- table aa</span></span><br><span class="line">    <span class="keyword">FROM</span> Spending <span class="keyword">JOIN</span></span><br><span class="line">        (   <span class="keyword">SELECT</span> <span class="string">'desktop'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line">            <span class="keyword">SELECT</span> <span class="string">'mobile'</span> <span class="keyword">AS</span> platform <span class="keyword">UNION</span></span><br><span class="line">            <span class="keyword">SELECT</span> <span class="string">'both'</span> <span class="keyword">AS</span> platform</span><br><span class="line">        ) <span class="keyword">AS</span> a </span><br><span class="line">) <span class="keyword">AS</span> ta</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> spend_date,</span><br><span class="line">       platform,</span><br><span class="line">       <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> total_amount,</span><br><span class="line">       <span class="keyword">COUNT</span>(user_id) <span class="keyword">AS</span> total_users</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> </span><br><span class="line">            spend_date,</span><br><span class="line">            user_id,</span><br><span class="line">            (<span class="keyword">CASE</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> platform)</span><br><span class="line">                <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> platform</span><br><span class="line">                <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">'both'</span></span><br><span class="line">            <span class="keyword">END</span>) <span class="keyword">AS</span> platform,</span><br><span class="line">            <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> amount</span><br><span class="line">        <span class="keyword">FROM</span> spending</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> spend_date, user_id</span><br><span class="line">    ) <span class="keyword">AS</span> b</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> spend_date, platform</span><br><span class="line">) <span class="keyword">as</span> tb</span><br><span class="line"><span class="keyword">ON</span> ta.platform = tb.platform</span><br><span class="line"><span class="keyword">AND</span> ta.spend_date = tb.spend_date</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> spend_date, total_users <span class="keyword">DESC</span>, total_amount;</span><br></pre></td></tr></table></figure>

<h3 id="1159-Market-Analysis-II"><a href="#1159-Market-Analysis-II" class="headerlink" title="1159.Market Analysis II"></a>1159.Market Analysis II</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">Table: Users</span><br><span class="line"></span><br><span class="line">+----------------+---------+</span><br><span class="line">| Column Name    | Type    |</span><br><span class="line">+----------------+---------+</span><br><span class="line">| user_id        | int     |</span><br><span class="line">| join_date      | date    |</span><br><span class="line">| favorite_brand | varchar |</span><br><span class="line">+----------------+---------+</span><br><span class="line">user_id is the primary key of this table.</span><br><span class="line">This table has the info of the users of an online shopping website where users can sell and buy items.</span><br><span class="line">Table: Orders</span><br><span class="line"></span><br><span class="line">+---------------+---------+</span><br><span class="line">| Column Name   | Type    |</span><br><span class="line">+---------------+---------+</span><br><span class="line">| order_id      | int     |</span><br><span class="line">| order_date    | date    |</span><br><span class="line">| item_id       | int     |</span><br><span class="line">| buyer_id      | int     |</span><br><span class="line">| seller_id     | int     |</span><br><span class="line">+---------------+---------+</span><br><span class="line">order_id is the primary key of this table.</span><br><span class="line">item_id is a foreign key to the Items table.</span><br><span class="line">buyer_id and seller_id are foreign keys to the Users table.</span><br><span class="line">Table: Items</span><br><span class="line"></span><br><span class="line">+---------------+---------+</span><br><span class="line">| Column Name   | Type    |</span><br><span class="line">+---------------+---------+</span><br><span class="line">| item_id       | int     |</span><br><span class="line">| item_brand    | varchar |</span><br><span class="line">+---------------+---------+</span><br><span class="line">item_id is the primary key of this table.</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Write an SQL query to find for each user, whether the brand of the second item (by date) they sold is their favorite brand. If a user sold less than two items, report the answer for that user as no.</span><br><span class="line"></span><br><span class="line">It is guaranteed that no seller sold more than one item on a day.</span><br><span class="line"></span><br><span class="line">The query result format is in the following example:</span><br><span class="line"></span><br><span class="line">Users table:</span><br><span class="line">+---------+------------+----------------+</span><br><span class="line">| user_id | join_date  | favorite_brand |</span><br><span class="line">+---------+------------+----------------+</span><br><span class="line">| 1       | 2019-01-01 | Lenovo         |</span><br><span class="line">| 2       | 2019-02-09 | Samsung        |</span><br><span class="line">| 3       | 2019-01-19 | LG             |</span><br><span class="line">| 4       | 2019-05-21 | HP             |</span><br><span class="line">+---------+------------+----------------+</span><br><span class="line"></span><br><span class="line">Orders table:</span><br><span class="line">+----------+------------+---------+----------+-----------+</span><br><span class="line">| order_id | order_date | item_id | buyer_id | seller_id |</span><br><span class="line">+----------+------------+---------+----------+-----------+</span><br><span class="line">| 1        | 2019-08-01 | 4       | 1        | 2         |</span><br><span class="line">| 2        | 2019-08-02 | 2       | 1        | 3         |</span><br><span class="line">| 3        | 2019-08-03 | 3       | 2        | 3         |</span><br><span class="line">| 4        | 2019-08-04 | 1       | 4        | 2         |</span><br><span class="line">| 5        | 2019-08-04 | 1       | 3        | 4         |</span><br><span class="line">| 6        | 2019-08-05 | 2       | 2        | 4         |</span><br><span class="line">+----------+------------+---------+----------+-----------+</span><br><span class="line"></span><br><span class="line">Items table:</span><br><span class="line">+---------+------------+</span><br><span class="line">| item_id | item_brand |</span><br><span class="line">+---------+------------+</span><br><span class="line">| 1       | Samsung    |</span><br><span class="line">| 2       | Lenovo     |</span><br><span class="line">| 3       | LG         |</span><br><span class="line">| 4       | HP         |</span><br><span class="line">+---------+------------+</span><br><span class="line"></span><br><span class="line">Result table:</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| seller_id | 2nd_item_fav_brand |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| 1         | no                 |</span><br><span class="line">| 2         | yes                |</span><br><span class="line">| 3         | yes                |</span><br><span class="line">| 4         | no                 |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line"></span><br><span class="line">The answer for the user with id 1 is no because they sold nothing.</span><br><span class="line">The answer for the users with id 2 and 3 is yes because the brands of their second sold items are their favorite brands.</span><br><span class="line">The answer for the user with id 4 is no because the brand of their second sold item is not their favorite brand.</span><br></pre></td></tr></table></figure>

<p>解题思路：</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id <span class="keyword">AS</span> seller_id, </span><br><span class="line">       <span class="keyword">IF</span>(item_brand = favorite_brand, <span class="string">'yes'</span>, <span class="string">'no'</span>) <span class="keyword">AS</span> <span class="number">2</span>nd_item_fav_brand </span><br><span class="line"><span class="keyword">FROM</span>   (<span class="keyword">SELECT</span> user_id, </span><br><span class="line">               favorite_brand, </span><br><span class="line">               (<span class="keyword">SELECT</span>    item_id</span><br><span class="line">                <span class="keyword">FROM</span>      orders o </span><br><span class="line">                <span class="keyword">WHERE</span>     user_id = o.seller_id </span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date <span class="keyword">limit</span> <span class="number">1</span>, <span class="number">1</span>) <span class="keyword">AS</span> item_id</span><br><span class="line">        <span class="keyword">FROM</span>   <span class="keyword">users</span>) <span class="keyword">AS</span> u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> items <span class="keyword">AS</span> i </span><br><span class="line"><span class="keyword">ON</span>        u.item_id = i.item_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> seller_id;</span><br></pre></td></tr></table></figure>

<h3 id="1194-Tournament-Winners"><a href="#1194-Tournament-Winners" class="headerlink" title="1194.Tournament Winners"></a>1194.Tournament Winners</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Table: Players</span><br><span class="line"></span><br><span class="line">+-------------+-------+</span><br><span class="line">| Column Name | Type  |</span><br><span class="line">+-------------+-------+</span><br><span class="line">| player_id   | int   |</span><br><span class="line">| group_id    | int   |</span><br><span class="line">+-------------+-------+</span><br><span class="line">player_id is the primary key of this table.</span><br><span class="line">Each row of this table indicates the group of each player.</span><br><span class="line">Table: Matches</span><br><span class="line"></span><br><span class="line">+---------------+---------+</span><br><span class="line">| Column Name   | Type    |</span><br><span class="line">+---------------+---------+</span><br><span class="line">| match_id      | int     |</span><br><span class="line">| first_player  | int     |</span><br><span class="line">| second_player | int     | </span><br><span class="line">| first_score   | int     |</span><br><span class="line">| second_score  | int     |</span><br><span class="line">+---------------+---------+</span><br><span class="line">match_id is the primary key of this table.</span><br><span class="line">Each row is a record of a match, first_player and second_player contain the player_id of each match.</span><br><span class="line">first_score and second_score contain the number of points of the first_player and second_player respectively.</span><br><span class="line">You may assume that, in each match, players belongs to the same group.</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">The winner in each group is the player who scored the maximum total points within the group. </span><br><span class="line">In the case of a tie, the lowest player_id wins.</span><br><span class="line"></span><br><span class="line">Write an SQL query to find the winner in each group.</span><br><span class="line"></span><br><span class="line">The query result format is in the following example:</span><br><span class="line"></span><br><span class="line">Players table:</span><br><span class="line">+-----------+------------+</span><br><span class="line">| player_id | group_id   |</span><br><span class="line">+-----------+------------+</span><br><span class="line">| 15        | 1          |</span><br><span class="line">| 25        | 1          |</span><br><span class="line">| 30        | 1          |</span><br><span class="line">| 45        | 1          |</span><br><span class="line">| 10        | 2          |</span><br><span class="line">| 35        | 2          |</span><br><span class="line">| 50        | 2          |</span><br><span class="line">| 20        | 3          |</span><br><span class="line">| 40        | 3          |</span><br><span class="line">+-----------+------------+</span><br><span class="line"></span><br><span class="line">Matches table:</span><br><span class="line">+------------+--------------+---------------+-------------+--------------+</span><br><span class="line">| match_id   | first_player | second_player | first_score | second_score |</span><br><span class="line">+------------+--------------+---------------+-------------+--------------+</span><br><span class="line">| 1          | 15           | 45            | 3           | 0            |</span><br><span class="line">| 2          | 30           | 25            | 1           | 2            |</span><br><span class="line">| 3          | 30           | 15            | 2           | 0            |</span><br><span class="line">| 4          | 40           | 20            | 5           | 2            |</span><br><span class="line">| 5          | 35           | 50            | 1           | 1            |</span><br><span class="line">+------------+--------------+---------------+-------------+--------------+</span><br><span class="line"></span><br><span class="line">Result table:</span><br><span class="line">+-----------+------------+</span><br><span class="line">| group_id  | player_id  |</span><br><span class="line">+-----------+------------+ </span><br><span class="line">| 1         | 15         |</span><br><span class="line">| 2         | 35         |</span><br><span class="line">| 3         | 40         |</span><br><span class="line">+-----------+------------+</span><br></pre></td></tr></table></figure>

<p>解题思路：本题的意思是每个运动员在5场比赛中获取的分数累加，得到累加和。然后每个运动员又分组，找出每组内累加和最高的运动员，如果累加和一样高，那选出player_id更小的。</p>
<p>首先找出每个运动员在5场比赛中各自的分数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> first_player <span class="keyword">AS</span> player_id, first_score <span class="keyword">AS</span> score</span><br><span class="line"><span class="keyword">FROM</span> Matches</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> second_player <span class="keyword">AS</span> player_id, second_score <span class="keyword">AS</span> score</span><br><span class="line"><span class="keyword">FROM</span> Matches;</span><br></pre></td></tr></table></figure>
<p>得到的结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-----------+-------+</span><br><span class="line">| player_id | score |</span><br><span class="line">+-----------+-------+</span><br><span class="line">|        15 |     3 |</span><br><span class="line">|        30 |     1 |</span><br><span class="line">|        30 |     2 |</span><br><span class="line">|        40 |     5 |</span><br><span class="line">|        35 |     1 |</span><br><span class="line">|        45 |     0 |</span><br><span class="line">|        25 |     2 |</span><br><span class="line">|        15 |     0 |</span><br><span class="line">|        20 |     2 |</span><br><span class="line">|        50 |     1 |</span><br><span class="line">+-----------+-------+</span><br></pre></td></tr></table></figure>

<p>然后把这个表和运动员表连接，并对运动员id分组，求出每个运动员所有分数总和</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	p.group_id, </span><br><span class="line">    ps.player_id, </span><br><span class="line">    <span class="keyword">SUM</span>(ps.score) <span class="keyword">AS</span> score</span><br><span class="line"><span class="keyword">FROM</span> Players <span class="keyword">AS</span> p</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> first_player <span class="keyword">AS</span> player_id, first_score <span class="keyword">AS</span> score</span><br><span class="line">    <span class="keyword">FROM</span> Matches</span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> second_player <span class="keyword">AS</span> player_id, second_score <span class="keyword">AS</span> score</span><br><span class="line">    <span class="keyword">FROM</span> Matches</span><br><span class="line">) <span class="keyword">AS</span> ps</span><br><span class="line"><span class="keyword">ON</span> p.player_id = ps.player_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> ps.player_id</span><br><span class="line"><span class="keyword">ORDER</span>  <span class="keyword">BY</span> <span class="keyword">group_id</span>, </span><br><span class="line">		  score <span class="keyword">DESC</span>, </span><br><span class="line">		  player_id;</span><br></pre></td></tr></table></figure>
<p>得到结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+----------+-----------+-------+</span><br><span class="line">| group_id | player_id | score |</span><br><span class="line">+----------+-----------+-------+</span><br><span class="line">|        1 |        15 |     3 |</span><br><span class="line">|        1 |        30 |     3 |</span><br><span class="line">|        1 |        25 |     2 |</span><br><span class="line">|        1 |        45 |     0 |</span><br><span class="line">|        2 |        35 |     1 |</span><br><span class="line">|        2 |        50 |     1 |</span><br><span class="line">|        3 |        40 |     5 |</span><br><span class="line">|        3 |        20 |     2 |</span><br><span class="line">+----------+-----------+-------+</span><br></pre></td></tr></table></figure>
<p>最后，对这个表中的group_id分组，找出每个组内分数最高的，如果分数相同，找出player_id更小的。</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">group_id</span>,</span><br><span class="line">    player_id</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> </span><br><span class="line">            p.group_id, </span><br><span class="line">            ps.player_id, </span><br><span class="line">            <span class="keyword">SUM</span>(ps.score) <span class="keyword">AS</span> score</span><br><span class="line">        <span class="keyword">FROM</span> Players <span class="keyword">AS</span> p</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> first_player <span class="keyword">AS</span> player_id, first_score <span class="keyword">AS</span> score</span><br><span class="line">            <span class="keyword">FROM</span> Matches</span><br><span class="line">            <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">            <span class="keyword">SELECT</span> second_player <span class="keyword">AS</span> player_id, second_score <span class="keyword">AS</span> score</span><br><span class="line">            <span class="keyword">FROM</span> Matches</span><br><span class="line">        ) <span class="keyword">AS</span> ps</span><br><span class="line">        <span class="keyword">ON</span> p.player_id = ps.player_id</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> ps.player_id</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">group_id</span>, </span><br><span class="line">                score <span class="keyword">DESC</span>, </span><br><span class="line">                player_id</span><br><span class="line">) <span class="keyword">AS</span> top_scores</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">group_id</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1225-Report-Contiguous-Dates"><a href="#1225-Report-Contiguous-Dates" class="headerlink" title="1225.Report Contiguous Dates"></a>1225.Report Contiguous Dates</h3><p>题目描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Table: Failed</span><br><span class="line"></span><br><span class="line">+--------------+---------+</span><br><span class="line">| Column Name  | Type    |</span><br><span class="line">+--------------+---------+</span><br><span class="line">| fail_date    | date    |</span><br><span class="line">+--------------+---------+</span><br><span class="line">Primary key for this table is fail_date.</span><br><span class="line">Failed table contains the days of failed tasks.</span><br><span class="line">Table: Succeeded</span><br><span class="line"></span><br><span class="line">+--------------+---------+</span><br><span class="line">| Column Name  | Type    |</span><br><span class="line">+--------------+---------+</span><br><span class="line">| success_date | date    |</span><br><span class="line">+--------------+---------+</span><br><span class="line">Primary key for this table is success_date.</span><br><span class="line">Succeeded table contains the days of succeeded tasks.</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">A system is running one task every day. Every task is independent of the previous tasks. The tasks can fail or succeed.</span><br><span class="line"></span><br><span class="line">Write an SQL query to generate a report of period_state for each continuous interval of days in the period from 2019-01-01 to 2019-12-31.</span><br><span class="line"></span><br><span class="line">period_state is &#39;failed&#39; if tasks in this interval failed or &#39;succeeded&#39; if tasks in this interval succeeded. Interval of days are retrieved as start_date and end_date.</span><br><span class="line"></span><br><span class="line">Order result by start_date.</span><br><span class="line"></span><br><span class="line">The query result format is in the following example:</span><br><span class="line"></span><br><span class="line">Failed table:</span><br><span class="line">+-------------------+</span><br><span class="line">| fail_date         |</span><br><span class="line">+-------------------+</span><br><span class="line">| 2018-12-28        |</span><br><span class="line">| 2018-12-29        |</span><br><span class="line">| 2019-01-04        |</span><br><span class="line">| 2019-01-05        |</span><br><span class="line">+-------------------+</span><br><span class="line"></span><br><span class="line">Succeeded table:</span><br><span class="line">+-------------------+</span><br><span class="line">| success_date      |</span><br><span class="line">+-------------------+</span><br><span class="line">| 2018-12-30        |</span><br><span class="line">| 2018-12-31        |</span><br><span class="line">| 2019-01-01        |</span><br><span class="line">| 2019-01-02        |</span><br><span class="line">| 2019-01-03        |</span><br><span class="line">| 2019-01-06        |</span><br><span class="line">+-------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Result table:</span><br><span class="line">+--------------+--------------+--------------+</span><br><span class="line">| period_state | start_date   | end_date     |</span><br><span class="line">+--------------+--------------+--------------+</span><br><span class="line">| succeeded    | 2019-01-01   | 2019-01-03   |</span><br><span class="line">| failed       | 2019-01-04   | 2019-01-05   |</span><br><span class="line">| succeeded    | 2019-01-06   | 2019-01-06   |</span><br><span class="line">+--------------+--------------+--------------+</span><br><span class="line"></span><br><span class="line">The report ignored the system state in 2018 as we care about the system in the period 2019-01-01 to 2019-12-31.</span><br><span class="line">From 2019-01-01 to 2019-01-03 all tasks succeeded and the system state was &quot;succeeded&quot;.</span><br><span class="line">From 2019-01-04 to 2019-01-05 all tasks failed and system state was &quot;failed&quot;.</span><br><span class="line">From 2019-01-06 to 2019-01-06 all tasks succeeded and system state was &quot;succeeded&quot;.</span><br></pre></td></tr></table></figure>

<p>解题思路：Failed 和 Succeeded表，用来记录一个每日定时跑的系统任务的失败和成功。要求返回一张结果表，按顺序展示该任务失败和成功的连续时间段以及起止时间。</p>
<p>首先找出在2019年成功和失败的所有任务：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        fail_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">        <span class="string">'failed'</span> <span class="keyword">AS</span> state</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">Failed</span></span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        success_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">        <span class="string">'succeeded'</span> <span class="keyword">AS</span> state</span><br><span class="line">    <span class="keyword">FROM</span> Succeeded</span><br><span class="line">) <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">date</span> <span class="keyword">BETWEEN</span> <span class="string">'2019-01-01'</span> <span class="keyword">AND</span> <span class="string">'2019-12-31'</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">date</span>;</span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+-----------+</span><br><span class="line">| date       | state     |</span><br><span class="line">+------------+-----------+</span><br><span class="line">| 2019-01-01 | succeeded |</span><br><span class="line">| 2019-01-02 | succeeded |</span><br><span class="line">| 2019-01-03 | succeeded |</span><br><span class="line">| 2019-01-04 | failed    |</span><br><span class="line">| 2019-01-05 | failed    |</span><br><span class="line">| 2019-01-06 | succeeded |</span><br><span class="line">+------------+-----------+</span><br></pre></td></tr></table></figure>

<p>然后在这个表中，继续增加两列：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> *</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> fail_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">               <span class="string">'failed'</span> <span class="keyword">AS</span> state</span><br><span class="line">        <span class="keyword">FROM</span> <span class="keyword">Failed</span></span><br><span class="line">        <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">        <span class="keyword">SELECT</span> success_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">               <span class="string">'succeeded'</span> <span class="keyword">AS</span> state</span><br><span class="line">        <span class="keyword">FROM</span> Succeeded</span><br><span class="line">	) <span class="keyword">AS</span> a</span><br><span class="line">	<span class="keyword">WHERE</span> <span class="built_in">date</span> <span class="keyword">BETWEEN</span> <span class="string">'2019-01-01'</span> <span class="keyword">AND</span> <span class="string">'2019-12-31'</span> </span><br><span class="line">	<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">date</span></span><br><span class="line">) <span class="keyword">AS</span> b, </span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">rank</span> := <span class="number">0</span>,</span><br><span class="line">	   @prev := <span class="string">"unkonwn"</span></span><br><span class="line"></span><br><span class="line">) <span class="keyword">AS</span> c;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+-----------+------------+--------------------+</span><br><span class="line">| date       | state     | @rank :&#x3D; 0 | @prev :&#x3D; &quot;unkonwn&quot; |</span><br><span class="line">+------------+-----------+------------+--------------------+</span><br><span class="line">| 2019-01-01 | succeeded |          0 | unkonwn            |</span><br><span class="line">| 2019-01-02 | succeeded |          0 | unkonwn            |</span><br><span class="line">| 2019-01-03 | succeeded |          0 | unkonwn            |</span><br><span class="line">| 2019-01-04 | failed    |          0 | unkonwn            |</span><br><span class="line">| 2019-01-05 | failed    |          0 | unkonwn            |</span><br><span class="line">| 2019-01-06 | succeeded |          0 | unkonwn            |</span><br><span class="line">+------------+-----------+------------+--------------------+</span><br></pre></td></tr></table></figure>
<p>然后对rank和prev更新，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	state,</span><br><span class="line">    <span class="built_in">date</span>,</span><br><span class="line">    @<span class="keyword">rank</span> := <span class="keyword">CASE</span> </span><br><span class="line">				<span class="keyword">WHEN</span> @prev = state <span class="keyword">THEN</span> @<span class="keyword">rank</span></span><br><span class="line">                <span class="keyword">ELSE</span> @<span class="keyword">rank</span> + <span class="number">1</span></span><br><span class="line">			 <span class="keyword">END</span> <span class="keyword">AS</span> <span class="keyword">rank</span>,</span><br><span class="line">	@prev := state <span class="keyword">AS</span> prev</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> *</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> fail_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">               <span class="string">'failed'</span> <span class="keyword">AS</span> state</span><br><span class="line">        <span class="keyword">FROM</span> <span class="keyword">Failed</span></span><br><span class="line">        <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">        <span class="keyword">SELECT</span> success_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">               <span class="string">'succeeded'</span> <span class="keyword">AS</span> state</span><br><span class="line">        <span class="keyword">FROM</span> Succeeded</span><br><span class="line">	) <span class="keyword">AS</span> a</span><br><span class="line">	<span class="keyword">WHERE</span> <span class="built_in">date</span> <span class="keyword">BETWEEN</span> <span class="string">'2019-01-01'</span> <span class="keyword">AND</span> <span class="string">'2019-12-31'</span> </span><br><span class="line">	<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">date</span></span><br><span class="line">) <span class="keyword">AS</span> b, </span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">rank</span> := <span class="number">0</span>,</span><br><span class="line">	   @prev := <span class="string">"unkonwn"</span></span><br><span class="line"></span><br><span class="line">) <span class="keyword">AS</span> c;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+-----------+------------+------+-----------+</span><br><span class="line">| state     | date       | rank | prev      |</span><br><span class="line">+-----------+------------+------+-----------+</span><br><span class="line">| succeeded | 2019-01-01 |    1 | succeeded |</span><br><span class="line">| succeeded | 2019-01-02 |    1 | succeeded |</span><br><span class="line">| succeeded | 2019-01-03 |    1 | succeeded |</span><br><span class="line">| failed    | 2019-01-04 |    2 | failed    |</span><br><span class="line">| failed    | 2019-01-05 |    2 | failed    |</span><br><span class="line">| succeeded | 2019-01-06 |    3 | succeeded |</span><br><span class="line">+-----------+------------+------+-----------+</span><br></pre></td></tr></table></figure>
<p>最后，对rank分组，即对任务状态分组，分别求每组date的最小值和最大值就是该组任务的起止时间</p>
<p>通过代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    state     <span class="keyword">AS</span> period_state,</span><br><span class="line">    <span class="keyword">MIN</span>(<span class="built_in">date</span>) <span class="keyword">AS</span> start_date,</span><br><span class="line">    <span class="keyword">MAX</span>(<span class="built_in">date</span>) <span class="keyword">AS</span> end_date</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        state,</span><br><span class="line">        <span class="built_in">date</span>,</span><br><span class="line">        @<span class="keyword">rank</span> := <span class="keyword">CASE</span> </span><br><span class="line">                    <span class="keyword">WHEN</span> @prev = state <span class="keyword">THEN</span> @<span class="keyword">rank</span></span><br><span class="line">                    <span class="keyword">ELSE</span> @<span class="keyword">rank</span> + <span class="number">1</span></span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">AS</span> <span class="keyword">rank</span>,</span><br><span class="line">        @prev := state <span class="keyword">AS</span> prev</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> *</span><br><span class="line">        <span class="keyword">FROM</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> fail_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">                <span class="string">'failed'</span> <span class="keyword">AS</span> state</span><br><span class="line">            <span class="keyword">FROM</span> <span class="keyword">Failed</span></span><br><span class="line">            <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">            <span class="keyword">SELECT</span> success_date <span class="keyword">AS</span> <span class="built_in">date</span>,</span><br><span class="line">                <span class="string">'succeeded'</span> <span class="keyword">AS</span> state</span><br><span class="line">            <span class="keyword">FROM</span> Succeeded</span><br><span class="line">        ) <span class="keyword">AS</span> a</span><br><span class="line">        <span class="keyword">WHERE</span> <span class="built_in">date</span> <span class="keyword">BETWEEN</span> <span class="string">'2019-01-01'</span> <span class="keyword">AND</span> <span class="string">'2019-12-31'</span> </span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">date</span></span><br><span class="line">    ) <span class="keyword">AS</span> b, </span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">SELECT</span> @<span class="keyword">rank</span> := <span class="number">0</span>,</span><br><span class="line">        @prev := <span class="string">"unkonwn"</span></span><br><span class="line"></span><br><span class="line">    ) <span class="keyword">AS</span> c</span><br><span class="line">) <span class="keyword">AS</span> d</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.rank</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date;</span><br></pre></td></tr></table></figure></div></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://huanyouchen.github.io/2019/11/03/SQL-exercises-LeetCode-hard-part/';
    this.page.identifier = '2019/11/03/SQL-exercises-LeetCode-hard-part/';
    this.page.title = 'LeetCode中的sql练习题-hard部分';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//huanyouchen-blog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//huanyouchen-blog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://huanyouchen-blog.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">幻悠尘的小窝.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>